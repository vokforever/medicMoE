# Структура проекта AI Doctor Bot

## Обзор
Проект разбит на модули для экономии токенов в ИИ-кодере и улучшения читаемости кода.

## Модули

### 1. `config.py` - Конфигурация и инициализация
**Описание**: Содержит все настройки, константы и инициализацию клиентов.
**Содержит**:
- Переменные окружения
- Конфигурацию ИИ-моделей (OpenRouter, Groq, Cerebras)
- Инициализацию клиентов (Supabase, Tavily, OpenAI)
- Константы (лимиты токенов, настройки истории)
- Медицинские источники

**Размер**: ~150 строк
**Токены**: ~2,000

### 2. `models.py` - Работа с ИИ-моделями
**Описание**: Управляет вызовом ИИ-моделей с failover логикой.
**Содержит**:
- Проверку доступности моделей
- Управление лимитами токенов
- Функцию `call_model_with_failover` с автоматическим переключением между провайдерами
- Обработку ошибок и диагностику

**Размер**: ~300 строк
**Токены**: ~4,500

### 3. `agents.py` - Интеллектуальные агенты
**Описание**: Содержит агентов для анализа и принятия решений.
**Содержит**:
- `ClarificationAgent` - определяет, достаточно ли информации для ответа
- `TestAnalysisAgent` - анализирует результаты медицинских анализов
- `IntelligentQueryAnalyzer` - определяет тип запроса и режим работы ИИ

**Размер**: ~400 строк
**Токены**: ~6,000

### 4. `database.py` - Работа с базой данных
**Описание**: Управляет всеми операциями с базой данных.
**Содержит**:
- Функции для работы с профилями пациентов
- Сохранение и получение медицинских записей
- Управление результатами анализов
- Функции обратной связи и кэширования

**Размер**: ~250 строк
**Токены**: ~3,500

### 5. `utils.py` - Утилиты и вспомогательные функции
**Описание**: Содержит вспомогательные функции для обработки данных.
**Содержит**:
- Поиск в медицинских источниках и интернете
- Векторный поиск по базе знаний
- Извлечение данных пациентов из текста
- Анализ изображений и PDF
- Проверка дубликатов

**Размер**: ~500 строк
**Токены**: ~7,500

### 6. `keyboards.py` - Клавиатуры Telegram
**Описание**: Содержит все инлайн-клавиатуры для бота.
**Содержит**:
- Клавиатуры обратной связи
- Главное меню
- Клавиатуры для работы с профилями
- Клавиатуры для анализа данных

**Размер**: ~100 строк
**Токены**: ~1,500

### 7. `main_new.py` - Основной файл бота
**Описание**: Основной файл с обработчиками команд и сообщений.
**Содержит**:
- Инициализацию бота и диспетчера
- Обработчики команд (/start, /profile, /stats, etc.)
- Основную логику работы бота
- Планировщик задач

**Размер**: ~400 строк
**Токены**: ~6,000

### 8. `structured_tests_agent.py` - Агент структурированных анализов
**Описание**: Отдельный модуль для работы со структурированными медицинскими данными.
**Содержит**:
- Извлечение структурированных данных из анализов
- Управление таблицами результатов
- Дополнение недостающих данных

**Размер**: ~200 строк
**Токены**: ~3,000

## Преимущества модульной структуры

### 1. Экономия токенов
- **Было**: 1 файл на 3,844 строки (~57,000 токенов)
- **Стало**: 8 модулей по 150-500 строк (~2,000-7,500 токенов каждый)

### 2. Улучшенная читаемость
- Каждый модуль имеет четкую ответственность
- Легче найти нужную функцию
- Проще отлаживать код

### 3. Переиспользование
- Модули можно импортировать в другие проекты
- Легче тестировать отдельные компоненты
- Возможность параллельной разработки

### 4. Обслуживание
- Изменения в одном модуле не влияют на другие
- Проще добавлять новые функции
- Легче отслеживать изменения в git

## Рекомендации по использованию

### Для разработки
1. **Начинайте с `config.py`** - настройте все необходимые API ключи
2. **Изучите `models.py`** - понимание работы с ИИ-моделями
3. **Работайте с `database.py`** - для изменения структуры данных
4. **Добавляйте функции в `utils.py`** - для новых утилит

### Для отладки
1. **Проверьте логи** - каждый модуль имеет детальное логирование
2. **Используйте `/models` команду** - для проверки статуса ИИ-моделей
3. **Проверьте конфигурацию** - в `config.py`

### Для расширения
1. **Создайте новый модуль** - если добавляете новую функциональность
2. **Импортируйте в `main_new.py`** - для интеграции с ботом
3. **Обновите документацию** - в этом файле

## Токены по модулям (приблизительно)

| Модуль | Строк | Токенов | % от общего |
|--------|-------|---------|-------------|
| config.py | 150 | 2,000 | 6% |
| models.py | 300 | 4,500 | 13% |
| agents.py | 400 | 6,000 | 17% |
| database.py | 250 | 3,500 | 10% |
| utils.py | 500 | 7,500 | 21% |
| keyboards.py | 100 | 1,500 | 4% |
| main_new.py | 400 | 6,000 | 17% |
| structured_tests_agent.py | 200 | 3,000 | 9% |
| **ИТОГО** | **2,300** | **34,000** | **100%** |

## Экономия токенов
- **Было**: ~57,000 токенов в одном файле
- **Стало**: ~34,000 токенов в модулях
- **Экономия**: ~40% токенов
- **Улучшение**: Читаемость и поддерживаемость кода

## Зависимости между модулями

```
main_new.py
├── config.py
├── models.py
├── agents.py
├── database.py
├── utils.py
├── keyboards.py
└── structured_tests_agent.py
    └── config.py (supabase)
```

## Заключение
Модульная структура значительно улучшает качество кода и экономит токены при работе с ИИ-кодером. Каждый модуль имеет четкую ответственность и может быть легко модифицирован без влияния на другие части системы.
