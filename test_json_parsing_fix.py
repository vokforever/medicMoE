#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
"""

import asyncio
import logging
import json
from enhanced_test_extractor import EnhancedTestExtractor

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

async def test_json_parsing():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON"""
    
    extractor = EnhancedTestExtractor()
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON")
    print("=" * 50)
    
    # –¢–µ—Å—Ç 1: –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º JSON
    print("\nüìã –¢–µ—Å—Ç 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç–≤–µ—Ç")
    test_response_1 = '''
    {
        "tests": [
            {
                "test_name": "Anti-HCV total",
                "result": "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ",
                "reference_values": "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ",
                "units": "–ú–ï/–º–ª",
                "test_system": "Abbott Architect",
                "equipment": "Alinity i",
                "test_date": "05.11.2025"
            },
            {
                "test_name": "Anti-HBs total",
                "result": "–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ",
                "reference_values": "10 –º–ú–ï/–º–ª –∏ –±–æ–ª–µ–µ",
                "units": "–º–ú–ï/–º–ª",
                "test_system": "Abbott Architect",
                "equipment": "Alinity i",
                "test_date": "05.11.2025"
            }
        ]
    }
    '''
    
    tests_1 = extractor._extract_tests_manually(test_response_1)
    print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: {len(tests_1)}")
    for test in tests_1:
        print(f"   - {test['test_name']}: {test['result']}")
    
    # –¢–µ—Å—Ç 2: –û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –±–µ–∑ JSON (—Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
    print("\nüìã –¢–µ—Å—Ç 2: –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ JSON")
    test_response_2 = '''
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–≤ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã, —è –Ω–∞—à–µ–ª —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
    
    Anti-HCV total: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ
    Anti-HBs total: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ (15.5 –º–ú–ï/–º–ª)
    Anti-HEV IgG: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ
    
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
    –¢–µ—Å—Ç-—Å–∏—Å—Ç–µ–º–∞: Abbott Architect
    –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: Alinity i
    –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 05.11.2025
    '''
    
    tests_2 = extractor._extract_tests_manually(test_response_2)
    print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: {len(tests_2)}")
    for test in tests_2:
        print(f"   - {test['test_name']}: {test['result']}")
    
    # –¢–µ—Å—Ç 3: –°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (JSON + —Ç–µ–∫—Å—Ç)
    print("\nüìã –¢–µ—Å—Ç 3: –°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")
    test_response_3 = '''
    –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö:
    
    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
    Anti-HCV total: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ - –Ω–æ—Ä–º–∞
    Anti-HBs total: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ - –∑–∞—â–∏—Ç–Ω—ã–π —Ç–∏—Ç—Ä
    
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã:
    –ë–∏–ª–∏—Ä—É–±–∏–Ω –æ–±—â–∏–π: 12.5 –º–∫–º–æ–ª—å/–ª (–Ω–æ—Ä–º–∞: 5-21)
    –ê–õ–¢: 25 –ï–¥/–ª (–Ω–æ—Ä–º–∞: –¥–æ 40)
    
    –í —Ñ–æ—Ä–º–∞—Ç–µ JSON —ç—Ç–æ –±—ã–ª–æ –±—ã:
    {"tests": [{"test_name": "Anti-HCV total", "result": "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ"}]}
    '''
    
    tests_3 = extractor._extract_tests_manually(test_response_3)
    print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: {len(tests_3)}")
    for test in tests_3:
        print(f"   - {test['test_name']}: {test['result']}")
    
    # –¢–µ—Å—Ç 4: –ü—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
    print("\nüìã –¢–µ—Å—Ç 4: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç")
    test_response_4 = '''
    –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
    –¢–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–µ–º—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤.
    '''
    
    tests_4 = extractor._extract_tests_manually(test_response_4)
    print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: {len(tests_4)}")
    
    # –¢–µ—Å—Ç 5: –û—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
    print("\nüìã –¢–µ—Å—Ç 5: JSON —Å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–æ–π")
    test_response_5 = '''
    {
        "tests": [
            {
                "test_name": "Anti-HCV total",
                "result": "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ",
                "reference_values": "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ"
            },
            {
                "test_name": "Anti-HBs total",
                "result": "–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ",
                "reference_values": "10 –º–ú–ï/–º–ª –∏ –±–æ–ª–µ–µ",
                // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞—Ä—É—à–∞—é—â–∏–π JSON
            }
        ]
    }
    '''
    
    tests_5 = extractor._extract_tests_manually(test_response_5)
    print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: {len(tests_5)}")
    for test in tests_5:
        print(f"   - {test['test_name']}: {test['result']}")
    
    print("\n" + "=" * 50)
    print("üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    print("‚úÖ –†—É—á–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ fallback")
    print("‚úÖ –†–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è")

if __name__ == "__main__":
    asyncio.run(test_json_parsing())
