import logging
from typing import List, Tuple, Dict, Any
from datetime import datetime, timedelta
from models import call_model_with_failover
from config import supabase, AGENT_CACHE_EXPIRE_HOURS

# –ê–≥–µ–Ω—Ç –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ –ò–ò
class ClarificationAgent:
    def __init__(self):
        self.max_clarifications = 3  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    
    async def analyze_and_ask(self, user_message: str, history: List[Dict[str, str]] = None, 
                             patient_data: Dict[str, Any] = None, clarification_count: int = 0,
                             has_medical_records: bool = False) -> Tuple[bool, str, str]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –ò–ò.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            - is_enough: True, –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∏–Ω–∞—á–µ False
            - response: –£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ None
            - ai_mode: "assistant" (–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—Ä–∞—á–∞ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö) –∏–ª–∏ "doctor" (–ò–ò-–≤—Ä–∞—á –≥–ª–∞–≤–Ω—ã–π)
        """
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–ª–∏—á–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π
        if has_medical_records:
            # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤—Ä–∞—á–∞
            ai_mode = "assistant"
        else:
            # –ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑–æ–≤ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
            ai_mode = "assistant"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –º–æ–¥–µ–ª–∏
        context = f"""
        –¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å.
        –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞.
        
        –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∑–∞–¥–∞–π –û–î–ò–ù —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ.
        –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–æ "–î–ê".
        
        –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}
        
        –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:
        """
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
        if history:
            for msg in history[-5:]:  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                context += f"{msg['role']}: {msg['content']}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
        if patient_data:
            context += f"\n–î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞:\n"
            if patient_data.get("name"):
                context += f"–ò–º—è: {patient_data['name']}\n"
            if patient_data.get("age"):
                context += f"–í–æ–∑—Ä–∞—Å—Ç: {patient_data['age']}\n"
            if patient_data.get("gender"):
                context += f"–ü–æ–ª: {patient_data['gender']}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —É—Ç–æ—á–Ω–µ–Ω–∏–π
        context += f"\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∂–µ –∑–∞–¥–∞–Ω–Ω—ã—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {clarification_count}\n"
        
        context += """
        –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º —É—Ç–æ—á–Ω—è—é—â–∏–º –≤–æ–ø—Ä–æ—Å–æ–º, –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∏–ª–∏ —Å–ª–æ–≤–æ–º '–î–ê', –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
        –ù–µ –∑–∞–¥–∞–≤–∞–π –±–æ–ª–µ–µ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ï—Å–ª–∏ —É–∂–µ –±—ã–ª–æ –∑–∞–¥–∞–Ω–æ 3 –≤–æ–ø—Ä–æ—Å–∞, –≤–µ—Ä–Ω–∏ '–î–ê'.
        """
        
        try:
            messages = [
                {"role": "system", "content": "–¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."},
                {"role": "user", "content": context}
            ]
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
            response, provider, metadata = await call_model_with_failover(
                messages=messages,
                system_prompt="–¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å.",
                model_type="text"
            )
            
            response = response.strip()
            
            if response == "–î–ê" or clarification_count >= self.max_clarifications:
                # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏ –µ—Å—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ò–ò-–≤—Ä–∞—á–∞ –≥–ª–∞–≤–Ω–æ–≥–æ
                if has_medical_records:
                    ai_mode = "doctor"
                return True, None, ai_mode
            else:
                return False, response, ai_mode
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –≤ ClarificationAgent: {e}")
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
            if has_medical_records:
                ai_mode = "doctor"
            return True, None, ai_mode

# –ê–≥–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ horizon-beta
class TestAnalysisAgent:
    def __init__(self):
        pass  # –£–±–∏—Ä–∞–µ–º –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å

    async def analyze_test_results(self, text: str) -> List[Dict[str, Any]]:
        """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        try:
            messages = [
                {
                    "role": "system",
                    "content": f"""–¢—ã ‚Äî –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑–∞–º. –ò–∑–≤–ª–µ–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
                    
                    –¢–ï–ö–£–©–ê–Ø –î–ê–¢–ê: {datetime.now().strftime('%d.%m.%Y')} (–≥–æ–¥: {datetime.now().year})
                    
                    –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —É–∫–∞–∂–∏:
                    1. –ù–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º)
                    2. –ó–Ω–∞—á–µ–Ω–∏–µ
                    3. –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–æ—Ä–º–∞)
                    4. –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
                    5. –î–∞—Ç—É –∞–Ω–∞–ª–∏–∑–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    6. –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –Ω–æ—Ä–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    
                    –ü—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ —É—á–∏—Ç—ã–≤–∞–π —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π –≤–æ–∑—Ä–∞—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º.
                    
                    –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –º–∞—Å—Å–∏–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤:
                    [
                        {{
                            "test_name": "–ù–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞",
                            "value": "–ó–Ω–∞—á–µ–Ω–∏–µ",
                            "reference_range": "–†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è",
                            "unit": "–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è",
                            "test_date": "–ì–ì–ì–ì-–ú–ú-–î–î",
                            "is_abnormal": true/false,
                            "notes": "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è"
                        }}
                    ]
                    –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ—Ç, —É–∫–∞–∂–∏ null. –ï—Å–ª–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω—ã, —É–∫–∞–∂–∏ null."""
                },
                {
                    "role": "user",
                    "content": text[:4000]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
                }
            ]
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
            response_text, _, _ = await call_model_with_failover(
                messages=messages,
                system_prompt="–¢—ã ‚Äî –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑–∞–º. –ò–∑–≤–ª–µ–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.",
                model_type="text"
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            import json
            import re
            json_match = re.search(r'\[.*\]', response_text, re.DOTALL)
            if json_match:
                json_str = json_match.group(0)
                try:
                    data = json.loads(json_str)
                    return data
                except json.JSONDecodeError:
                    pass
            return []
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–æ–≤: {e}")
            return []

    async def get_test_summary(self, user_id: str, test_names: List[str] = None) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –ø–æ –∞–Ω–∞–ª–∏–∑–∞–º –ø–∞—Ü–∏–µ–Ω—Ç–∞"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            cache_key = f"summary_{user_id}_{'_'.join(test_names) if test_names else 'all'}"
            cached = supabase.table("doc_agent_cache").select("*").eq("user_id", user_id).eq("query",
                                                                                             cache_key).execute()
            if cached.data and datetime.now() < datetime.fromisoformat(cached.data[0]["expires_at"]):
                return cached.data[0]["result"]["summary"]

            # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑—ã –∏–∑ –±–∞–∑—ã
            query = supabase.table("doc_test_results").select("*").eq("user_id", user_id)
            if test_names:
                # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º –∞–Ω–∞–ª–∏–∑–æ–≤
                conditions = []
                for name in test_names:
                    conditions.append(f"test_name.ilike.%{name}%")
                query = query.or_(*conditions)
            results = query.order("test_date", desc=True).limit(50).execute()

            if not results.data:
                return "–£ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤."

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            tests_text = "–ê–Ω–∞–ª–∏–∑—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞:\n"
            for test in results.data:
                tests_text += f"- {test['test_name']}: {test['value']} {test['unit'] or ''} (–Ω–æ—Ä–º–∞: {test['reference_range'] or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}) –æ—Ç {test['test_date'] or '–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
                if test.get('is_abnormal'):
                    tests_text += f"  –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –Ω–æ—Ä–º—ã: {test.get('notes', '–µ—Å—Ç—å')}\n"

            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑—ã
            messages = [
                {
                    "role": "system",
                    "content": """–¢—ã ‚Äî –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã –∏ –¥–∞–π –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É:
                    1. –í—ã–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è
                    2. –£–∫–∞–∂–∏, –∫–∞–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –Ω–æ—Ä–º—ã
                    3. –î–∞–π –æ–±—â—É—é –æ—Ü–µ–Ω–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
                    4. –†–µ–∫–æ–º–µ–Ω–¥—É–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
                    –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""
                },
                {
                    "role": "user",
                    "content": tests_text
                }
            ]
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
            summary, _, _ = await call_model_with_failover(
                messages=messages,
                system_prompt="–¢—ã ‚Äî –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã –∏ –¥–∞–π –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É.",
                model_type="text"
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            supabase.table("doc_agent_cache").insert({
                "user_id": user_id,
                "query": cache_key,
                "result": {"summary": summary},
                "expires_at": (datetime.now() + timedelta(hours=AGENT_CACHE_EXPIRE_HOURS)).isoformat()
            }).execute()

            return summary
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–≤–æ–¥–∫–∏ –∞–Ω–∞–ª–∏–∑–æ–≤: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É –∞–Ω–∞–ª–∏–∑–æ–≤."

# –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
class IntelligentQueryAnalyzer:
    def __init__(self):
        self.analysis_patterns = [
            "–∞–Ω–∞–ª–∏–∑", "–∞–Ω–∞–ª–∏–∑—ã", "—Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å", "–∫—Ä–æ–≤—å", "–º–æ—á–∞", 
            "–±–∏–æ—Ö–∏–º–∏—è", "–æ–±—â–∏–π –∞–Ω–∞–ª–∏–∑", "—Ç–µ—Å—Ç", "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", "–Ω–æ—Ä–º–∞", "–∑–Ω–∞—á–µ–Ω–∏–µ",
            "anti-hev", "anti-hev igg", "–≥–µ–ø–∞—Ç–∏—Ç", "igg", "igm", "–∞–Ω—Ç–∏—Ç–µ–ª–∞"
        ]
        
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
        self.specific_indicator_patterns = [
            "–∫–∞–∫–∏–µ —É –º–µ–Ω—è", "—á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç", "–º–æ–π", "–º–æ–∏", "—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", "–∑–Ω–∞—á–µ–Ω–∏—è",
            "–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏", "–∞–Ω–∞–ª–∏–∑—ã –ø–æ", "—Ç–µ—Å—Ç –Ω–∞", "—É—Ä–æ–≤–µ–Ω—å", "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è"
        ]
    
    async def analyze_query_type(self, question: str, user_id: str) -> Dict[str, Any]:
        """
        –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–∏–ø–µ –∑–∞–ø—Ä–æ—Å–∞.
        """
        try:
            logging.info(f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞: {question} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}")
            
            # –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            from database import get_medical_records
            medical_records = get_medical_records(user_id)
            has_medical_data = len(medical_records) > 0
            
            logging.info(f"–ù–∞–π–¥–µ–Ω–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π: {len(medical_records)}")
            
            # –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–∞
            question_lower = question.lower()
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å–æ–º –æ–± –∞–Ω–∞–ª–∏–∑–∞—Ö
            is_analysis_question = any(pattern in question_lower for pattern in self.analysis_patterns)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö
            is_specific_indicator_question = await self._is_specific_indicator_question(question, medical_records)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ —Ä–µ–∂–∏–º –≤—Ä–∞—á–∞
            needs_doctor_mode = await self._needs_doctor_mode(question, medical_records)
            
            result = {
                "is_analysis_question": is_analysis_question,
                "is_specific_indicator_question": is_specific_indicator_question,
                "needs_doctor_mode": needs_doctor_mode,
                "has_medical_data": has_medical_data,
                "medical_records": medical_records
            }
            
            logging.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞: {result}")
            return result
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
            return {
                "is_analysis_question": False,
                "is_specific_indicator_question": False,
                "needs_doctor_mode": False,
                "has_medical_data": False,
                "medical_records": []
            }
    
    async def _is_specific_indicator_question(self, question: str, medical_records: List[Dict]) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ –ò–ò –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
        """
        try:
            question_lower = question.lower()
            
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º - —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ
            has_specific_patterns = any(pattern in question_lower for pattern in self.specific_indicator_patterns)
            has_analysis_patterns = any(pattern in question_lower for pattern in self.analysis_patterns)
            
            logging.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: {question}")
            logging.info(f"–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã: {has_specific_patterns}, –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω–∞–ª–∏–∑–æ–≤: {has_analysis_patterns}")
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ò –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω–∞–ª–∏–∑–æ–≤ - —ç—Ç–æ —Ç–æ—á–Ω–æ –≤–æ–ø—Ä–æ—Å –æ–± –∞–Ω–∞–ª–∏–∑–∞—Ö
            if has_specific_patterns and has_analysis_patterns:
                logging.info("–í–æ–ø—Ä–æ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º")
                return True
            
            # –ï—Å–ª–∏ –Ω–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π, –Ω–æ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω–∞–ª–∏–∑–æ–≤ - —ç—Ç–æ —Ç–æ–∂–µ –≤–æ–ø—Ä–æ—Å –æ–± –∞–Ω–∞–ª–∏–∑–∞—Ö
            if not medical_records and has_analysis_patterns:
                logging.info("–í–æ–ø—Ä–æ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –∞–Ω–∞–ª–∏–∑ (–Ω–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π, –Ω–æ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã)")
                return True
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            if medical_records:
                logging.info("–ò—Å–ø–æ–ª—å–∑—É—é –ò–ò –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞")
                return await self._ai_check_specific_question(question, medical_records)
            
            logging.info("–í–æ–ø—Ä–æ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å")
            return False
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞: {e}")
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω–∞–ª–∏–∑–æ–≤, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –æ–± –∞–Ω–∞–ª–∏–∑–∞—Ö
            question_lower = question.lower()
            fallback_result = any(pattern in question_lower for pattern in self.analysis_patterns)
            logging.info(f"Fallback —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {fallback_result}")
            return fallback_result
    
    async def _needs_doctor_mode(self, question: str, medical_records: List[Dict]) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ —Ä–µ–∂–∏–º –≤—Ä–∞—á–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å.
        """
        try:
            if not medical_records:
                return False
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            context = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞:\n"
            for record in medical_records[:2]:
                if record.get('record_type') in ['analysis', 'image_analysis']:
                    content = record.get('content', '')[:300]
                    context += f"- {content[:100]}...\n"
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞
            messages = [
                {
                    "role": "system",
                    "content": """–û–ø—Ä–µ–¥–µ–ª–∏, –Ω—É–∂–µ–Ω –ª–∏ —Ä–µ–∂–∏–º –≤—Ä–∞—á–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                    
                    –í–µ—Ä–Ω–∏ "doctor" –µ—Å–ª–∏:
                    - –í–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –≥–ª—É–±–æ–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
                    - –ù—É–∂–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã
                    - –í–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞
                    - –ù—É–∂–Ω–æ –¥–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                    
                    –í–µ—Ä–Ω–∏ "assistant" –µ—Å–ª–∏:
                    - –í–æ–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π –∏ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    - –ù—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∞–Ω–∞–ª–∏–∑–æ–≤
                    - –í–æ–ø—Ä–æ—Å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
                    - –ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    """
                },
                {
                    "role": "user",
                    "content": f"–í–æ–ø—Ä–æ—Å: {question}\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: {context}"
                }
            ]
            
            response, _, _ = await call_model_with_failover(
                messages=messages,
                system_prompt="–û–ø—Ä–µ–¥–µ–ª–∏ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –ò–ò",
                model_type="text"
            )
            
            return "doctor" in response.lower()
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –ò–ò: {e}")
            return False
    
    async def get_relevant_medical_context(self, question: str, medical_records: List[Dict]) -> str:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ø—Ä–æ—Å–∞.
        –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º –ø–æ–∏—Å–∫–æ–º.
        """
        try:
            if not medical_records:
                logging.info("get_relevant_medical_context: –Ω–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π")
                return ""
            
            logging.info(f"get_relevant_medical_context: –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é {len(medical_records)} –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: {question}")
            
            question_lower = question.lower()
            context_parts = []
            
            # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º - —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ
            for record in medical_records:
                if record.get('record_type') in ['analysis', 'image_analysis']:
                    content = record.get('content', '')
                    content_lower = content.lower()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∑–∞–ø–∏—Å—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞
                    question_words = [word for word in question_lower.split() if len(word) > 3]
                    has_relevant_keywords = any(word in content_lower for word in question_words)
                    
                    logging.info(f"–ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–ø–∏—Å—å {record.get('record_type')}: –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ {question_words}, –Ω–∞–π–¥–µ–Ω—ã: {has_relevant_keywords}")
                    
                    # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
                    if has_relevant_keywords:
                        context_parts.append(content)
                        logging.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
                        continue
                    
                    # –ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, –Ω–æ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω–∞–ª–∏–∑–æ–≤, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å –ø–æ–º–æ—â—å—é –ò–ò
                    if any(pattern in question_lower for pattern in self.analysis_patterns):
                        logging.info("–ü—Ä–æ–≤–µ—Ä—è—é —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é –ò–ò")
                        is_relevant = await self._ai_check_relevance(question, content)
                        if is_relevant:
                            context_parts.append(content)
                            logging.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –ø–æ –ò–ò-–∞–Ω–∞–ª–∏–∑—É: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
            if not context_parts:
                logging.info("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, –ø—Ä–æ–≤–µ—Ä—è—é –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å –ø–æ–º–æ—â—å—é –ò–ò")
                for record in medical_records:
                    if record.get('record_type') in ['analysis', 'image_analysis']:
                        content = record.get('content', '')
                        is_relevant = await self._ai_check_relevance(question, content)
                        if is_relevant:
                            context_parts.append(content)
                            logging.info(f"–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –ø–æ –ò–ò-–∞–Ω–∞–ª–∏–∑—É (–≤—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥): {len(content)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏
            if context_parts:
                full_context = "\n\nüìä –í–ê–®–ò –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ï –î–ê–ù–ù–´–ï:\n"
                for i, part in enumerate(context_parts, 1):
                    full_context += f"\n--- –ó–∞–ø–∏—Å—å {i} ---\n{part}\n"
                
                # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                if len(full_context) > 8000:
                    full_context = full_context[:8000] + "\n\n... (–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–µ–∑–∞–Ω—ã –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª–∏–Ω—ã)"
                
                logging.info(f"–°–æ–∑–¥–∞–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ {len(context_parts)} –∑–∞–ø–∏—Å–µ–π, –æ–±—â–∞—è –¥–ª–∏–Ω–∞: {len(full_context)} —Å–∏–º–≤–æ–ª–æ–≤")
                return full_context
            
            logging.info("–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return ""
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {e}")
            return ""
    
    async def _ai_check_relevance(self, question: str, content: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∑–∞–ø–∏—Å–∏ —Å –ø–æ–º–æ—â—å—é –ò–ò"""
        try:
            logging.info(f"–ü—Ä–æ–≤–µ—Ä—è—é —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –¥–ª–∏–Ω–æ–π {len(content)} —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: {question}")
            
            messages = [
                {
                    "role": "system",
                    "content": """–û–ø—Ä–µ–¥–µ–ª–∏, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —ç—Ç–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∑–∞–ø–∏—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –≤–æ–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                    
                    –í–µ—Ä–Ω–∏ "–î–ê" –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç:
                    - –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–æ–≤ –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∏–∑ –≤–æ–ø—Ä–æ—Å–∞
                    - –î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å
                    - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã, –æ –∫–æ—Ç–æ—Ä—ã—Ö —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    
                    –í–µ—Ä–Ω–∏ "–ù–ï–¢" –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ –≤–æ–ø—Ä–æ—Å—É."""
                },
                {
                    "role": "user",
                    "content": f"–í–æ–ø—Ä–æ—Å: {question}\n\n–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∑–∞–ø–∏—Å—å: {content[:1000]}"
                }
            ]
            
            relevance_response, _, _ = await call_model_with_failover(
                messages=messages,
                system_prompt="–û–ø—Ä–µ–¥–µ–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∑–∞–ø–∏—Å–∏",
                model_type="text"
            )
            
            is_relevant = "–î–ê" in relevance_response.strip().upper()
            logging.info(f"–ò–ò –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {is_relevant} (–æ—Ç–≤–µ—Ç: {relevance_response.strip()})")
            
            return is_relevant
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏: {e}")
            return False
    
    async def _ai_check_specific_question(self, question: str, medical_records: List[Dict]) -> bool:
        """–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –ø–æ–º–æ—â—å—é –ò–ò"""
        try:
            logging.info(f"–ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞: {question}")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            context = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞:\n"
            for record in medical_records[:3]:  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                if record.get('record_type') in ['analysis', 'image_analysis']:
                    content = record.get('content', '')[:500]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                    context += f"- {content[:100]}...\n"
            
            # –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º False
            if "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞:\n" == context:
                logging.info("–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞—é False")
                return False
            
            logging.info(f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò-–∞–Ω–∞–ª–∏–∑–∞: {len(context)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞
            messages = [
                {
                    "role": "system",
                    "content": """–¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û–ø—Ä–µ–¥–µ–ª–∏, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –∞–Ω–∞–ª–∏–∑–æ–≤.
                    
                    –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ "–î–ê" –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å:
                    - –°–æ–¥–µ—Ä–∂–∏—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤, —Ç–µ—Å—Ç–æ–≤ –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
                    - –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö, –∑–Ω–∞—á–µ–Ω–∏—è—Ö –∏–ª–∏ –Ω–æ—Ä–º–∞—Ö
                    - –û—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –¥–∞–Ω–Ω—ã–º –∏–∑ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø–∞—Ü–∏–µ–Ω—Ç–∞
                    
                    –í–µ—Ä–Ω–∏ "–ù–ï–¢" –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å:
                    - –û–±—â–∏–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
                    - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±—â—É—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    - –ù–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º –ø–∞—Ü–∏–µ–Ω—Ç–∞
                    
                    –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å "–î–ê":
                    - "–ö–∞–∫–∏–µ —É –º–µ–Ω—è –∞–Ω–∞–ª–∏–∑—ã –ø–æ anti-HEV IgG?"
                    - "–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–π –≥–µ–º–æ–≥–ª–æ–±–∏–Ω?"
                    - "–ú–æ–π —Å–∞—Ö–∞—Ä –≤ –Ω–æ—Ä–º–µ?"
                    - "–ü–æ–∫–∞–∂–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤"
                    
                    –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å "–ù–ï–¢":
                    - "–ß—Ç–æ —Ç–∞–∫–æ–µ –≥–µ–ø–∞—Ç–∏—Ç?"
                    - "–ö–∞–∫–∏–µ –±—ã–≤–∞—é—Ç –≤–∏–¥—ã –∞–Ω–∞–ª–∏–∑–æ–≤ –∫—Ä–æ–≤–∏?"
                    - "–ö–∞–∫ –ø–∏—Ç–∞—Ç—å—Å—è –ø—Ä–∏ –¥–∏–∞–±–µ—Ç–µ?"
                    - "–û–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç–∞–∫–æ–µ –∞–ª–ª–µ—Ä–≥–∏—è"
                    """
                },
                {
                    "role": "user",
                    "content": f"–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}\n\n{context}"
                }
            ]
            
            response, _, _ = await call_model_with_failover(
                messages=messages,
                system_prompt="–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                model_type="text"
            )
            
            is_specific = "–î–ê" in response.strip().upper()
            logging.info(f"–ò–ò –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞: {is_specific} (–æ—Ç–≤–µ—Ç: {response.strip()})")
            
            return is_specific
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞: {e}")
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ò–ò, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º True –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω–∞–ª–∏–∑–æ–≤
            question_lower = question.lower()
            fallback_result = any(pattern in question_lower for pattern in self.analysis_patterns)
            logging.info(f"Fallback —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –ò–ò: {fallback_result}")
            return fallback_result
